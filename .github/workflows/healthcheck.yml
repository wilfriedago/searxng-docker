name: Health Check

on:
  workflow_run:
    workflows: ["Deploy to VPS"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose health check output'
        required: false
        default: false
        type: boolean

jobs:
  health-check:
    name: Run Health Check
    runs-on: ubuntu-latest
    # Only run if the deploy workflow succeeded or if manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
    - name: Run deployment script
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          cd ${{ secrets.DEPLOY_PATH }}
          echo "üè• Running health check..."
          echo "üìç Current directory: $(pwd)"
          echo "üìã Latest commit: $(git log -1 --oneline)"

          # Run health check with optional verbose flag
          if [ "${{ github.event.inputs.verbose || 'false' }}" = "true" ]; then
            echo "üîç Running verbose health check..."
            ./scripts/health-check.sh --verbose
          else
            ./scripts/health-check.sh
          fi

    - name: Notify health check status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Health check passed successfully"
          echo "üìä Health check summary:"
          echo "  - Triggered by: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "  - Deploy workflow: ${{ github.event.workflow_run.conclusion }}"
            echo "  - Deploy commit: ${{ github.event.workflow_run.head_sha }}"
          fi
        else
          echo "‚ùå Health check failed"
          echo "üö® Health check failure details:"
          echo "  - Triggered by: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "  - Deploy workflow: ${{ github.event.workflow_run.conclusion }}"
            echo "  - Deploy commit: ${{ github.event.workflow_run.head_sha }}"
          fi
          exit 1
        fi

  notify-failure:
    name: Handle Deploy Failure
    runs-on: ubuntu-latest
    # Only run if the deploy workflow failed
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
    - name: Notify deploy failure
      run: |
        echo "‚ö†Ô∏è Skipping health check because deployment failed"
        echo "üìä Deploy failure details:"
        echo "  - Deploy workflow: ${{ github.event.workflow_run.conclusion }}"
        echo "  - Deploy commit: ${{ github.event.workflow_run.head_sha }}"
        echo "  - Please check the deployment logs before running health checks"
